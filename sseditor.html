<html>
<head>
<meta charset="UTF-8" />
<title>说说编辑器</title>
<style type="text/css">
#emotion{-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;}
</style>
</head>
<body>
	<div id="emotion" unselectable="on">表情按钮</div>
	<div>
		<span>测试文字</span>
	</div>
	
	<div id="J_append">添加到后面去</div>
<script>
(function(win){
	var canplaceholder = 'placeholder' in document.createElement('input'),
	isIEs = 'onbeforedeactivate' in document, isW3CRangeSupport = !!window.getSelection;
	
	var ssEditor = window.ssEditor = function(id, fn){
		return new ssEditor.prototype.init(id, fn);
	}
	ssEditor.prototype = {
		constructor: ssEditor,
		init: function(id, fn){
			var me = this, content = id.nodeType == 1 ? id : document.getElementById(id),
				ifr = document.createElement('iframe'), ifrdoc;
			this.editor = ifr;
			
			ifr.frameBorder = 0;
			ifr.scrolling = 'no';
			var next = content.nextSibling, pnode = content.parentNode;
			//避免选择节点是最后一个节点
			if(next){
				pnode.insertBefore(ifr, next);
			}else{
				pnode.appendChild(ifr);
			}
			
			
			var ifrwin = ifr.contentWindow, ifrdoc = ifrwin.document;
			ifrdoc.designMode = "on";
			ifrdoc.open();
			ifrdoc.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><style type="text/css">html,body{width:100%;height:100%;}body{font-family:"Microsoft YaHei", Arial, Helvetica, sans-serif;font-size:12px;background:#fff;border:0;padding:0;}</style></head><body></body></html>');
			ifrdoc.close();
			var ifrbody = ifrdoc.body;
			//ifrbody.contentEditable = true;
			ifrbody.onpaste = function(e){
				//var clipboardData = e.clipboardData || window.clipboardData;
				//console.log(clipboardData.getData("text"));
				
				if(e.clipboardData){
					//alert('e')
					e.clipboardData.setData("text/plain", 'value');
				}else if(window.clipboardData){
					//alert('window')
					window.clipboardData.setData("text", 'value');
				}
				return
				var clipboardData = e.clipboardData, i = 0, items, item, types;
				
				if( clipboardData ){
					items = clipboardData.items;
					if(!items){
						return;
					}
					console.log(items)
					item = items[0];
					types = clipboardData.types || [];
					for( ; i < types.length; i++ ){
						if( types[i] === 'Files' ){
							item = items[i];
							break;
						}
					}
					if( item && item.kind === 'file' && item.type.match(/^image\//i) ){
						//imgReader( item );
					}
				}
			};
			//ifrbody.oncontextmenu = function(e){  };
			ifrbody.ondrop = function(){
				return false;
				//maybe filter by http://www.bitscn.com/school/Javascript/201408/308356.html
				//http://www.it165.net/design/html/201402/2506.html
			};
			ifr.onbeforedeactivate = function(){
				me.updatebookmark();
			}
			ifr.onactivate = function(){
				var selectionRange = me.bookmark, bookmark;
				if(selectionRange && selectionRange.getBookmark){
					bookmark = selectionRange.getBookmark();
				}
				if(bookmark){
					var range = ifrdoc.selection.createRange();
					range.moveToBookmark(bookmark);
					range.select();
					me.bookmark = null;
				}
			}
			
			//初始化完成后的回调
			fn && fn.call(this, editor);
			return this;
		},
		updatebookmark: function(){
			var w = this.editor.contentWindow;
			if(!isW3CRangeSupport){
				try {
					this.bookmark = w.document.selection.createRange();
				} catch (ex) {
					
				}
			}else{
				try {
					//var sel = w.getSelection();
					/*if(!isIEs){
						this.bookmark = sel;
					}else if(sel.getRangeAt && sel.rangeCount){
						this.bookmark = sel.getRangeAt(0);
					}*/
					this.bookmark = w.getSelection().getRangeAt(0).cloneRange();
				} catch (ex) {
					/*this.focus();*/
				}
			}
			return this;
		},
		insertHtmlAtCaret: function(html){
			var lastRange = this.bookmark, ifrwin = this.editor.contentWindow,
				ifrdoc = ifrwin.document, ifrbody = ifrdoc.body;
			ifrwin.focus();
			if(lastRange){
				if(lastRange && lastRange.text != undefined){
					//lastRange.pasteHTML(html);
					ifrdoc.selection.createRange().pasteHTML(html);
				}else if(isW3CRangeSupport){
					// IE9 and non-IE
					//IE9-11光标位置问题有待解决
			        var sel = ifrwin.getSelection();
			        /*if(!isIEs){
			        	selectedRange = sel.getRangeAt(0);
			        }*/
			        
			        if(sel.getRangeAt && sel.rangeCount){
			        	//selectedRange = sel.getRangeAt(0);
			        	console.log(lastRange.focusNode)
			        	/*selectedRange.setEndPoint('EndToStart', lastRange);
						selectedRange.collapse(false);
						selectedRange.setEndPoint('EndToEnd', lastRange);
						selectedRange.select();*/
			        	lastRange.deleteContents();
			            var el = ifrdoc.createElement("div");
			            el.innerHTML = html;
			            var frag = ifrdoc.createDocumentFragment(),
			                node, lastNode;
			            while((node = el.firstChild)){
			                lastNode = frag.appendChild(node);
			            }
			            lastRange.insertNode(frag);
			            if(lastNode){
			                selectedRange = lastRange.cloneRange();
			                selectedRange.setStartAfter(lastNode);
			                selectedRange.collapse(true);
			                sel.removeAllRanges();
			                sel.addRange(selectedRange);
			            }
			        }
				}
			}else{
				ifrbody.innerHTML += html;
				if(isW3CRangeSupport){
					var sel = ifrwin.getSelection();
					selectedRange = sel.getRangeAt(0);
					selectedRange = selectedRange.cloneRange();
	                selectedRange.setStartAfter(ifrbody.lastChild);
	                selectedRange.collapse(true);
	                sel.removeAllRanges();
	                sel.addRange(selectedRange);
				}
			}
			//链式调用直接返回
			return this.updatebookmark();
		}
	};
	
	ssEditor.prototype.init.prototype = ssEditor.prototype;
})(window);

window.onload = function(){
	var editor = ssEditor('J_editor'), i = 0;
	document.getElementById('emotion').onclick = function(){
		editor.insertHtmlAtCaret(i++);
	}
}
</script>
	<div id="J_editor"></div></body>
</html>